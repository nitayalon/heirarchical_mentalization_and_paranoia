---
title: "First task analysis"
author: "Nitay Alon"
date: "2023-02-28"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(here)
library(colorspace)
library(caret)
library(patchwork)
library(plotly)
library(ks)
library(ggpubr)
library(rstatix)
library(corrr)
library(emmeans)
library(effsize)
library(ARTool)
library(car)        
library(forcats) 
library(RColorBrewer)
library(wesanderson)
source("load_simulations_data.R")
```

```{r Plotting settings for aliasing on windows, include=FALSE}
# Plotting settings for aliasing on windows
# Enable anti-aliasing on Windows
if(Sys.info()['sysname'] == "Windows"){
  
  trace(grDevices::png, quote({
    if (missing(type) && missing(antialias)) {
      type <- "cairo-png"
      antialias <- "subpixel"
    }
  }), print = FALSE)
  
  
  # Enable anti-aliasing on Windows
  trace(grDevices:::png, quote({
    if (missing(type) && missing(antialias)) {
      type <- "cairo-png"
      antialias <- "subpixel"
    }
  }), print = FALSE)
  
  
}

# Define general plot style and style
base_size = 15
theme_set(theme_classic(base_size = base_size))

parse_experiment_file <- function(file_name)
{
  parameters_list <- strsplit(file_name, "_")[[1]]
  alpha = parameters_list[4]
  receiver_threshold = parameters_list[7]
  sender_threshold = parameters_list[10]
  return(c(alpha, receiver_threshold, sender_threshold))
}
```

```{r set experiment path, include=FALSE}
results_path = "~/Max_Planck/Hierarchical-modelling/data"
dom_levels = list(
               c("0","-1"),
               c("0","1"),
               c("2","-1"),
               c("2","1"))
agents_beliefs <- c("receiver_beliefs", "sender_beliefs")
nested_beliefs <- c("type_belief", "nested_beliefs")
directory_pattern <- "DoM%s_receiver_DoM%s_sender_softmax_temp_0.01"
path_to_game_results <- paste0(results_path, directory_pattern)
```

```{r}
first_task_data <- load_simulations_results(results_path, "first_task", "first_task/2_rational_agents/short_duration", directory_pattern, dom_levels)
```

# Comparing game results by DoM levels

```{r data for cumulative reward plots}
cumulative_reward_results <- 
  first_task_data$game_results %>% 
  mutate(sender_threshold = ifelse(sender_threshold > 0, sender_threshold, "Random")) %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold),
         receiver_dom_level = factor(receiver_dom_level),
         receiver_threshold = factor(receiver_threshold)) %>% 
  group_by(sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold, seed) %>% 
  summarise(total_receiver_reward = sum(receiver_reward),
            total_sender_reward = sum(sender_reward)) %>% 
  group_by(sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold) %>% 
  summarise(total_receiver_reward = mean(total_receiver_reward),
            total_sender_reward = mean(total_sender_reward))
  
```
```{r setting colours}
custom_colors <- list(
  sender_tom = brewer.pal(5, "Greens")[c(1,3,5)],
  receiver_tom = brewer.pal(5, "Blues")[c(3,5)]
)
senders_colours <- c("#F191BC", "#E6007E", "#9363A6")
senders_types <- c(expression(paste(eta,"=0.1")),
                  expression(paste(eta,"=0.5")),
                  "Random")
receivers_colours <- c("#ee531f", "#f59879")
receivers_types <- c(expression(paste(eta,"=0.0")),
                      expression(paste(eta,"=0.35")))
```


```{r cumulative reward by experiment setting}
sender_reward_plot <- 
  cumulative_reward_results %>% 
  ggplot(aes(receiver_threshold, total_sender_reward, fill = sender_threshold)) + 
  geom_col(position = "dodge2") + 
  facet_grid(.~sender_dom_level) + 
  ylab("Cumulative sender reward") + 
  xlab("Trial number") + 
  scale_y_continuous(
      expand = c(0,0),
      name = "Total sender reward",
      limits = c(0,12),
      breaks = seq(0,12,1)
    ) +
  scale_fill_manual(values = senders_colours,
                      name = expression(paste("Sender's ",theta)),
                    labels = senders_types) + 
   facet_grid(receiver_dom_level~sender_dom_level) 

receiver_reward_plot <-
  cumulative_reward_results %>% 
  ggplot(aes(receiver_threshold, total_receiver_reward, fill = sender_threshold)) + 
  geom_col(position = "dodge2") + 
  ylab("Cumulative receiver reward") + 
  xlab("Trial number") + 
  scale_fill_manual(values = senders_colours,
                      name = expression(paste("Sender's ",theta)),
                    labels = senders_types) + 
  scale_y_continuous(
      expand = c(0,0),
      name = "Total receiver reward",
      limits = c(0,12),
      breaks = seq(0,12,1)
    ) +
  facet_grid(receiver_dom_level~sender_dom_level) 

cumulative_reward <- sender_reward_plot + receiver_reward_plot
cumulative_reward
# ggsave("../figures/cumulative_reward_by_agent.png", width = 40, height = 20, units = "cm")
```

## Typical policy

```{r typical sender behaviour}
typical_offer_sequence <- 
  first_task_data$game_results %>% 
  mutate(sender_threshold = ifelse(sender_threshold > 0, sender_threshold, "Random")) %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold),
         receiver_dom_level = factor(receiver_dom_level),
         receiver_threshold = factor(receiver_threshold)) %>% 
  group_by(sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold, trial_number) %>% 
  summarise(average_offer = mean(offer),
            sd_offer = sd(offer),
            low_offer = min(offer),
            high_offer = max(offer))

typical_response_sequence <- 
  first_task_data$game_results %>% 
  mutate(sender_threshold = ifelse(sender_threshold > 0, sender_threshold, "Random")) %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold),
         receiver_dom_level = factor(receiver_dom_level),
         receiver_threshold = factor(receiver_threshold)) %>% 
  group_by(sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold, trial_number) %>% 
  summarise(average_response = mean(response),
            sd_response = sd(response),
            low_response = min(response),
            high_response = max(response))
```
```{r}
dom_0_receiver_plot <- 
typical_offer_sequence %>% 
  filter(sender_threshold != "Random",
         receiver_dom_level == 0) %>% 
  ggplot(aes(x= trial_number, y = average_offer, color = sender_threshold, fill=sender_threshold)) + 
  geom_line(size = 2.5) + 
  geom_ribbon(aes(ymin=average_offer-sd_offer, ymax=average_offer+sd_offer), linetype=2, alpha=0.1) + 
  scale_color_manual(values = senders_colours[1:2], 
                     name = (expression(paste("Sender's ",theta))),
                    labels = senders_types[1:2]) + 
  scale_fill_manual(values = senders_colours[1:2], 
                     name = (expression(paste("Sender's ",theta))),
                    labels = senders_types[1:2]) + 
  scale_x_continuous(
      expand = c(0,0),
      name = "Trial number",
      limits = c(0,13),
      breaks = seq(0,13,3)
    ) +
  scale_y_continuous(
      expand = c(0,0),
      name = "Average offer",
      limits = c(0,1),
      breaks = seq(0,1,0.25)
    ) +
  guides("none") + 
  ggtitle("DoM(0) receiver") + 
  facet_grid(sender_dom_level~receiver_threshold) 

dom_2_receiver_plot <- 
typical_offer_sequence %>% 
  filter(sender_threshold != "Random",
         receiver_dom_level == 2) %>% 
  ggplot(aes(x= trial_number, y = average_offer, color = sender_threshold, fill=sender_threshold)) + 
  geom_line(size = 2.5) + 
  geom_ribbon(aes(ymin=average_offer-sd_offer, ymax=average_offer+sd_offer), linetype=2, alpha=0.1) + 
  scale_color_manual(values = senders_colours[1:2], 
                     name = (expression(paste("Sender's ",theta))),
                    labels = senders_types[1:2]) + 
  scale_fill_manual(values = senders_colours[1:2], 
                     name = (expression(paste("Sender's ",theta))),
                    labels = senders_types[1:2]) + 
  xlab("Trial number") + 
  scale_y_continuous(
      expand = c(0,0),
      name = "Average offer",
      limits = c(0,1),
      breaks = seq(0,1,0.25)
    ) +
  scale_x_continuous(
      expand = c(0,0),
      name = "Trial number",
      limits = c(0,13),
      breaks = seq(0,13,3)
    ) +
  ggtitle("DoM(2) receiver") + 
  facet_grid(sender_dom_level~receiver_threshold)

sender_policy_plot <- dom_0_receiver_plot + dom_2_receiver_plot
sender_policy_plot + plot_layout(guides = "collect")
```

```{r correpsonding receiver policy}
dom_0_response_plot <- 
typical_response_sequence %>% 
  filter(sender_threshold != "Random",
         receiver_dom_level == 0) %>% 
  ggplot(aes(x= trial_number, y = average_response, color = receiver_threshold, fill=receiver_threshold)) + 
  geom_line(size = 2.5) + 
  geom_ribbon(aes(ymin=average_response-sd_response, ymax=average_response+sd_response), linetype=2, alpha=0.1) + 
  scale_color_manual(values = receivers_colours, 
                     name = (expression(paste("Receiver's ",theta))),
                    labels = receivers_types) + 
  scale_fill_manual(values = receivers_colours, 
                     name = (expression(paste("Receiver's ",theta))),
                    labels = receivers_types) + 
  scale_x_continuous(
      expand = c(0,0),
      name = "Trial number",
      limits = c(0,13),
      breaks = seq(0,13,3)
    ) +
  scale_y_continuous(
      expand = c(0,0),
      name = "Average offer",
      limits = c(0,1),
      breaks = seq(0,1,0.25)
    ) +
  guides("none") + 
  ggtitle("DoM(0) receiver") + 
  facet_grid(sender_dom_level~sender_threshold) 

dom_2_response_plot <- 
typical_response_sequence %>% 
  filter(sender_threshold != "Random",
         receiver_dom_level == 2) %>% 
  ggplot(aes(x= trial_number, y = average_response, color = receiver_threshold, fill=receiver_threshold)) + 
  geom_line(size = 2.5) + 
  geom_ribbon(aes(ymin=average_response-sd_response, ymax=average_response+sd_response), linetype=2, alpha=0.1) + 
  scale_color_manual(values = receivers_colours, 
                     name = (expression(paste("Receiver's ",theta))),
                    labels = receivers_types) + 
  scale_fill_manual(values = receivers_colours, 
                     name = (expression(paste("Receiver's ",theta))),
                    labels = receivers_types) + 
  scale_x_continuous(
      expand = c(0,0),
      name = "Trial number",
      limits = c(0,13),
      breaks = seq(0,13,3)
    ) +
  scale_y_continuous(
      expand = c(0,0),
      name = "Average offer",
      limits = c(0,1),
      breaks = seq(0,1,0.25)
    ) +
  ggtitle("DoM(2) receiver") + 
  facet_grid(sender_dom_level~sender_threshold) 

receiver_policy_plot <- dom_0_response_plot + dom_2_response_plot
receiver_policy_plot + plot_layout(guides = "collect")
```
## IRL verification

```{r IRL verification}
grouped_dom_0_beliefs <- 
  first_task_data$dom_0_receiver_beliefs %>% 
  mutate(sender_threshold = ifelse(sender_threshold > 0, sender_threshold, "Random")) %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold),
         receiver_dom_level = factor(receiver_dom_level),
         receiver_threshold = factor(receiver_threshold)) %>% 
  group_by(sender_dom_level, receiver_dom_level, receiver_threshold, sender_threshold, trial_number)

average_beliefs <- 
  grouped_dom_0_beliefs %>% 
  summarise(p_random = mean(p_0_0),
            p_low = mean(p_0_1),
            p_high = mean(p_0_2)) %>% 
  pivot_longer(col=!c(sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold, trial_number),
               names_to="Type", values_to = "Average") %>% 
  mutate(Type = as.factor(Type))

sd_beliefs <- 
  grouped_dom_0_beliefs %>% 
  summarise(p_random = sd(p_0_0),
            p_low = sd(p_0_1),
            p_high = sd(p_0_2)) %>% 
  pivot_longer(col=!c(sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold, trial_number),
               names_to="Type", values_to = "SD") %>% 
  mutate(Type = as.factor(Type))

min_beliefs <- 
  grouped_dom_0_beliefs %>% 
  summarise(p_random = min(p_0_0),
            p_low = min(p_0_1),
            p_high = min(p_0_2)) %>% 
  pivot_longer(col=!c(sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold, trial_number),
               names_to="Type", values_to = "Min") %>% 
  mutate(Type = as.factor(Type))

max_beliefs <- 
  grouped_dom_0_beliefs %>% 
  summarise(p_random = max(p_0_0),
            p_low = max(p_0_1),
            p_high = max(p_0_2)) %>% 
  pivot_longer(col=!c(sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold, trial_number),
               names_to="Type", values_to = "Max") %>% 
  mutate(Type = as.factor(Type))

agregated_beliefs <- 
  average_beliefs %>% 
  inner_join(sd_beliefs) %>% 
  inner_join(min_beliefs) %>% 
  inner_join(max_beliefs)
```
# DoM(0) beliefs

```{r}
corretct_beliefs <- 
  agregated_beliefs %>% 
  filter(sender_dom_level == "-1") %>% 
  mutate(Type = factor(Type, levels = c("p_random","p_low","p_high"))) %>% 
  ggplot(aes(x= trial_number, y = Average, color = Type, fill=Type)) + 
  geom_line(size = 2.5) + 
  geom_ribbon(aes(ymin=Min, ymax=Max), linetype=2, alpha=0.1) + 
  scale_color_manual(values = senders_colours[c(3,1,2)], 
                     name = (expression(paste("Sender's ",theta))),
                    labels = senders_types[c(3,2,2)]) + 
  scale_fill_manual(values = senders_colours[c(3,1,2)], 
                     name = (expression(paste("Sender's ",theta))),
                    labels = senders_types[c(3,1,2)]) + 
  facet_grid(vars(sender_threshold), vars(receiver_threshold))

corretct_beliefs

miscallibrated_beliefs <- 
  agregated_beliefs %>% 
  filter(sender_dom_level == "1") %>% 
  mutate(Type = factor(Type, levels = c("p_random","p_low","p_high"))) %>% 
  ggplot(aes(x= trial_number, y = Average, color = Type, fill=Type)) + 
  geom_line(size = 2.5) + 
  geom_ribbon(aes(ymin=Min, ymax=Max), linetype=2, alpha=0.1) + 
  scale_color_manual(values = senders_colours[c(3,2,1)], 
                     name = (expression(paste("Sender's ",theta))),
                    labels = senders_types[c(3,2,1)]) + 
  scale_fill_manual(values = senders_colours[c(3,2,1)], 
                     name = (expression(paste("Sender's ",theta))),
                    labels = senders_types[c(3,2,1)]) + 
  facet_grid(vars(sender_threshold), vars(receiver_threshold))

miscallibrated_beliefs
```
# DoM(1) beliefs

## Zero order beliefs

```{r}
average_beliefs <- 
  first_task_data$sender_beliefs %>% 
  mutate(sender_threshold = ifelse(sender_threshold > 0, sender_threshold, "Random")) %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold),
         receiver_dom_level = factor(receiver_dom_level),
         receiver_threshold = factor(receiver_threshold)) %>% 
  group_by(sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold, trial_number) %>% 
  summarise(p_low = mean(p_1_1_0),
            p_high = mean(p_1_1_1)) %>% 
  pivot_longer(col=!c(sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold, trial_number),
               names_to="Type", values_to = "Average")

sd_beliefs <- 
  first_task_data$sender_beliefs %>% 
  mutate(sender_threshold = ifelse(sender_threshold > 0, sender_threshold, "Random")) %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold),
         receiver_dom_level = factor(receiver_dom_level),
         receiver_threshold = factor(receiver_threshold)) %>% 
  group_by(sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold, trial_number) %>% 
  summarise(p_low = sd(p_1_1_0),
            p_high = sd(p_1_1_1)) %>%  
  pivot_longer(col=!c(sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold, trial_number),
               names_to="Type", values_to = "SD")

min_beliefs <- 
  first_task_data$sender_beliefs %>% 
  mutate(sender_threshold = ifelse(sender_threshold > 0, sender_threshold, "Random")) %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold),
         receiver_dom_level = factor(receiver_dom_level),
         receiver_threshold = factor(receiver_threshold)) %>% 
  group_by(sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold, trial_number) %>% 
  summarise(p_low = min(p_1_1_0),
            p_high = min(p_1_1_1)) %>%  
  pivot_longer(col=!c(sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold, trial_number),
               names_to="Type", values_to = "Min")

max_beliefs <- 
  first_task_data$sender_beliefs %>% 
  mutate(sender_threshold = ifelse(sender_threshold > 0, sender_threshold, "Random")) %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold),
         receiver_dom_level = factor(receiver_dom_level),
         receiver_threshold = factor(receiver_threshold)) %>% 
  group_by(sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold, trial_number) %>% 
  summarise(p_low = max(p_1_1_0),
            p_high = max(p_1_1_1)) %>%  
  pivot_longer(col=!c(sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold, trial_number),
               names_to="Type", values_to = "Max")

agregated_beliefs <- 
  average_beliefs %>% 
  inner_join(sd_beliefs) %>% 
  inner_join(min_beliefs) %>% 
  inner_join(max_beliefs)
```


```{r dom one irl}
corretct_beliefs <- 
  agregated_beliefs %>% 
  filter(receiver_dom_level == "0") %>% 
  mutate(Type = factor(Type, levels = c("p_low","p_high"))) %>% 
  ggplot(aes(x= trial_number, y = Average, color = Type, fill=Type)) + 
  geom_line(size = 2.5) + 
  geom_ribbon(aes(ymin=Min, ymax=Max), linetype=2, alpha=0.1) + 
  scale_color_manual(values = receivers_colours, 
                     name = (expression(paste("Receiver's ",theta))),
                    labels = receivers_types) + 
  scale_fill_manual(values = receivers_colours, 
                     name = (expression(paste("Receiver's ",theta))),
                    labels = receivers_types) + 
  facet_grid(vars(receiver_threshold), vars(sender_threshold))

corretct_beliefs


misplaced_beliefs <- 
  agregated_beliefs %>% 
  filter(receiver_dom_level == "2") %>% 
  mutate(Type = factor(Type, levels = c("p_low","p_high"))) %>% 
  ggplot(aes(x= trial_number, y = Average, color = Type, fill=Type)) + 
  geom_line(size = 2.5) + 
  geom_ribbon(aes(ymin=Min, ymax=Max), linetype=2, alpha=0.1) + 
  scale_color_manual(values = receivers_colours, 
                     name = (expression(paste("Receiver's ",theta))),
                    labels = receivers_types) + 
  scale_fill_manual(values = receivers_colours, 
                     name = (expression(paste("Receiver's ",theta))),
                    labels = receivers_types) + 
  facet_grid(vars(receiver_threshold), vars(sender_threshold))

misplaced_beliefs
```

## First order beliefs

```{r}
average_beliefs <- 
  first_task_data$sender_beliefs %>% 
  mutate(sender_threshold = ifelse(sender_threshold > 0, sender_threshold, "Random")) %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold),
         receiver_dom_level = factor(receiver_dom_level),
         receiver_threshold = factor(receiver_threshold)) %>% 
  group_by(sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold, trial_number) %>% 
  summarise(p_random = mean(q_1_1_0),
            p_low = mean(q_1_1_1),
            p_high = mean(q_1_1_2)) %>% 
  pivot_longer(col=!c(sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold, trial_number),
               names_to="Type", values_to = "Average")

sd_beliefs <- 
  first_task_data$sender_beliefs %>% 
  mutate(sender_threshold = ifelse(sender_threshold > 0, sender_threshold, "Random")) %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold),
         receiver_dom_level = factor(receiver_dom_level),
         receiver_threshold = factor(receiver_threshold)) %>% 
  group_by(sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold, trial_number) %>% 
  summarise(p_low = sd(p_1_1_0),
            p_high = sd(p_1_1_1)) %>%  
  pivot_longer(col=!c(sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold, trial_number),
               names_to="Type", values_to = "SD")

min_beliefs <- 
  first_task_data$sender_beliefs %>% 
  mutate(sender_threshold = ifelse(sender_threshold > 0, sender_threshold, "Random")) %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold),
         receiver_dom_level = factor(receiver_dom_level),
         receiver_threshold = factor(receiver_threshold)) %>% 
  group_by(sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold, trial_number) %>% 
  summarise(p_low = min(p_1_1_0),
            p_high = min(p_1_1_1)) %>%  
  pivot_longer(col=!c(sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold, trial_number),
               names_to="Type", values_to = "Min")

max_beliefs <- 
  first_task_data$sender_beliefs %>% 
  mutate(sender_threshold = ifelse(sender_threshold > 0, sender_threshold, "Random")) %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold),
         receiver_dom_level = factor(receiver_dom_level),
         receiver_threshold = factor(receiver_threshold)) %>% 
  group_by(sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold, trial_number) %>% 
  summarise(p_low = max(p_1_1_0),
            p_high = max(p_1_1_1)) %>%  
  pivot_longer(col=!c(sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold, trial_number),
               names_to="Type", values_to = "Max")

agregated_beliefs <- 
  average_beliefs %>% 
  inner_join(sd_beliefs) %>% 
  inner_join(min_beliefs) %>% 
  inner_join(max_beliefs)
```



# OLD ANALYSIS - we can remove it

## Detrimental effect of overmetaliastion

```{r Detrimental effect of overmetaliastion}
detrimental_effect_of_high_dom_plot <- 
  game_results %>% 
  filter(sender_dom_level == -1, sender_threshold > 0) %>% 
  mutate(sender_threshold = factor(sender_threshold)) %>% 
  group_by(trial_number, sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold) %>% 
  summarise(average_receiver_reward = mean(receiver_reward),
            average_sender_reward = mean(sender_reward)) %>% 
  arrange(sender_dom_level, receiver_dom_level, sender_threshold,
          receiver_threshold) %>% 
  group_by(receiver_threshold, sender_threshold, sender_dom_level, receiver_dom_level) %>% 
  mutate(cumulative_receiver_reward = cumsum(average_receiver_reward),
            cumulative_sender_reward = cumsum(average_sender_reward)) %>% 
  ggplot(aes(trial_number, cumulative_receiver_reward, colour = receiver_dom_level)) + 
  geom_line(size = 1.0, alpha = 0.5) + 
  ylab("Cumulative receiver reward") + 
  xlab("Trial number") + 
  scale_color_viridis_d(name = 'Receiver DoM level')+
  facet_grid(.~sender_threshold) 

ggsave("../figures/detrimental_effect_of_high_dom_plot.png", width = 40, height = 20, units = "cm")
```

## Learnt policies

Interestingly, the $DoM(1)$ learns to pretend to be random to 
maneuver the receiver into accepting its offers

```{r deep look into the sender policies}
sender_policy <- game_results %>% 
  filter(sender_threshold > 0) %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold),
         receiver_dom_level = factor(receiver_dom_level),
         receiver_threshold = factor(receiver_threshold)) %>% 
  mutate(dyad = fct_cross(sender_dom_level, receiver_dom_level)) %>% 
  group_by(trial_number, sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold) %>% 
  summarise(average_offer = mean(offer),
            average_reponse = mean(response)) %>% 
  arrange(sender_dom_level, receiver_dom_level, sender_threshold, receiver_threshold, trial_number) %>% 
  ggplot(aes(trial_number, average_offer, colour = sender_dom_level)) + 
  geom_line(size = 1.0) + 
  ylab("Average offer") + 
  xlab("Trial number") + 
  scale_color_viridis_d(name = expression(paste('Sender DoM')))+
  facet_grid(sender_threshold ~ receiver_dom_level) + 
  ggtitle('Sender policy')

corresponding_beliefs <- beliefs %>% 
  filter(agent_name %in% c("DoM(0)_receiver","DoM(2)_receiver"),
         sender_threshold > 0) %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold),
         receiver_dom_level = factor(receiver_dom_level),
         receiver_threshold = factor(receiver_threshold)) %>% 
  mutate(dyad = fct_cross(sender_dom_level, receiver_dom_level)) %>% 
  group_by(agent_name, trial_number, dyad,  sender_dom_level, receiver_dom_level,
           receiver_threshold, sender_threshold) %>% 
  mutate(`P(0.0)` = mean(`X0.0`),
         `P(0.1)` = mean(`X0.1`),
         `P(0.5)` = mean(`X0.5`)) %>% 
  ggplot() + 
  geom_line(aes(x = trial_number, y = `P(0.0)`, colour='`P(0.0)`',
                linetype = factor(sender_threshold)),
            size=1.0) + 
  geom_line(aes(x = trial_number, y = `P(0.1)`, colour='`P(0.1)`',
                linetype = factor(sender_threshold)),
            size=1.0) + 
  geom_line(aes(x = trial_number, y = `P(0.5)`, colour='`P(0.5)`',
                linetype = factor(sender_threshold)),
            size=1.0) + 
  scale_linetype_manual(values=c("solid", "dotted", "solid"))+
  scale_color_viridis_d(name = expression(paste('P(',gamma, ')')))+
  facet_grid(sender_dom_level ~ agent_name) + 
  labs(y = 'Posterior probability', x= 'Trial')+
  scale_linetype_manual("Sender threshold",values=c("0.5"=3,"0.1"=1)) + 
  ggtitle('Reciever posterior belief')

corresponding_beliefs
# ggsave("../figures/true_and_false_beliefs.png", width = 40, height = 20, units = "cm")

policy_and_belief_manipulation <- sender_policy + corresponding_beliefs
# ggsave("../figures/policies_and_belief_manipulation.png", width = 40, height = 20, units = "cm")
```


```{r deep look into the receiver policies}
game_results %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold),
         receiver_dom_level = factor(receiver_dom_level),
         receiver_threshold = factor(receiver_threshold)) %>% 
  mutate(dyad = fct_cross(sender_dom_level, receiver_dom_level)) %>% 
  group_by(trial_number, sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold) %>% 
  summarise(average_offer = mean(offer),
            average_reponse = mean(response)) %>%
  mutate(average_reponse_shape = ifelse(average_reponse > 0.5, "Accept", "Reject")) %>%  
  ggplot(aes(x = trial_number, y = average_reponse, shape = average_reponse_shape,
             colour = sender_dom_level)) + 
  geom_point(size=2.0) + 
  ylab("P(accept)") + 
  xlab("Trial number") + 
  scale_shape_manual(name = "Most likey response", values=c(15, 4)) + 
  scale_color_viridis_d(name = 'Sender DoM level')+
  facet_grid(sender_threshold ~ receiver_dom_level)
# ggsave("../figures/dom_0_receiver_policy.png", width = 40, height = 20, units = "cm")
```

```{r belief analysis}
beliefs %>% 
  filter(agent_name %in% c("DoM(0)_receiver","DoM(2)_receiver")) %>% 
  mutate(sender_threshold = ifelse(sender_threshold > 0, as.character(sender_threshold), "Random")) %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold),
         receiver_dom_level = factor(receiver_dom_level),
         receiver_threshold = factor(receiver_threshold)) %>% 
  group_by(trial_number,  sender_dom_level, receiver_dom_level,
           receiver_threshold, sender_threshold) %>% 
  mutate(`P(0.0)` = mean(`X0.0`),
         `P(0.1)` = mean(`X0.1`),
         `P(0.5)` = mean(`X0.5`)) %>% 
  ggplot() + 
  geom_line(aes(x = trial_number, y = `P(0.0)`, colour='`P(0.0)`',
                linetype = factor(sender_dom_level)),
            size=1.0) + 
  geom_line(aes(x = trial_number, y = `P(0.1)`, colour='`P(0.1)`',
                linetype = factor(sender_dom_level)),
            size=1.0) + 
  geom_line(aes(x = trial_number, y = `P(0.5)`, colour='`P(0.5)`',
                linetype = factor(sender_dom_level)),
            size=1.0) + 
  scale_linetype_manual(values=c("solid", "dotted", "solid"))+
  scale_color_viridis_d(name = expression(paste('P(',gamma, ')')))+
  facet_grid(receiver_dom_level~sender_threshold) + 
  labs(y = 'Posterior probability', x= 'Trial')
# ggsave("../figures/receiver_posterior_beliefs.png", width = 40, height = 20, units = "cm")
```

```{r time until the receiver decide that it playes with a random agent}
corresponding_beliefs <- 
  beliefs %>% 
  filter(agent_name %in% c("DoM(0)_receiver", "DoM(2)_receiver"),
         sender_threshold == 0) %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold),
         receiver_dom_level = factor(receiver_dom_level),
         receiver_threshold = factor(receiver_threshold)) %>% 
  mutate(sender_threshold = ifelse(as.character(sender_threshold), sender_threshold > 0, "Random")) %>% 
  group_by(agent_name, trial_number, receiver_dom_level) %>% 
  mutate(`P(Random)` = mean(`X0.0`)) %>% 
  mutate(certainty = ifelse(`P(Random)` > 0.99, 1, 0)) %>% 
  summarize(mean_time_to_call_random = mean(certainty)) %>% 
  ggplot(aes(trial_number, mean_time_to_call_random, colour = receiver_dom_level)) + 
  scale_color_viridis_d(name = "Receivre's DoM")+
  geom_line(size = 2) + 
  labs(y = 'Confidence level', x= 'Trial')
corresponding_beliefs
ggsave("../figures/time_to_detect_random_agent.png", width = 40, height = 20, units = "cm")
```

# Entropy analysis

```{r entropy analysis}
beliefs %>% 
  filter(agent_name %in% c("DoM(0)_receiver","DoM(2)_receiver")) %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold),
         receiver_dom_level = factor(receiver_dom_level),
         receiver_threshold = factor(receiver_threshold)) %>% 
  mutate(dyad = fct_cross(sender_dom_level, receiver_dom_level)) %>% 
  group_by(agent_name, trial_number, dyad,  sender_dom_level, receiver_dom_level,
           receiver_threshold, sender_threshold) %>% 
  mutate(`P(0.0)` = mean(`X0.0`),
         `P(0.1)` = mean(`X0.1`),
         `P(0.5)` = mean(`X0.5`)) %>% 
  mutate(`log_prob(0.0)` = log2(`P(0.0)`) * `P(0.0)`,
         `log_prob(0.1)` = log2(`P(0.1)`) * `P(0.1)`,
         `log_prob(0.5)` = log2(`P(0.5)`) * `P(0.5)`) %>% 
  summarise(entropy = -(`log_prob(0.0)` + `log_prob(0.1)` + `log_prob(0.5)`)) %>% 
  ggplot() + 
  geom_line(aes(x = trial_number, y = entropy, colour=sender_dom_level),
            size=1.5) + 
  scale_color_viridis_d(name = expression(paste('P(',gamma, ')')))+
  ylab("Entropy") + 
  xlab("Trial number") + 
  facet_grid(receiver_dom_level~sender_threshold)
# ggsave("../figures/posterior_beliefs_entropy.png", width = 40, height = 20, units = "cm")
```


Let's look at some games to learn more

```{r plot games for illustration}
sid = 210
sender_dom_level_for_plot = -1
receiver_dom_level_for_plot = 0

game_plot <- 
  game_results %>% 
  filter(receiver_dom_level == receiver_dom_level_for_plot,
         sender_dom_level == sender_dom_level_for_plot,
         seed == sid) %>% 
  mutate(sender_threshold = factor(sender_threshold),
         response = factor(response, labels = c('reject','accept'))) %>%
         # response = factor(response, labels = c('accept'))) %>%
  mutate(sender_threshold = factor(sender_threshold)) %>% 
  ggplot(aes(x = trial_number, y = offer)) + 
  geom_point(aes(shape = factor(response)), size = 1.5) + 
  geom_line(aes(colour = sender_threshold), alpha=0.5, size = 1.5) + 
  scale_color_viridis_d(name = expression(paste('Sender threshold')))+
  scale_shape_manual(values=c(4, 15)) +
  # scale_shape_manual(values=c(15, 4)) +
  scale_x_continuous(name="Trial", breaks=seq(0, 20, 1)) +
  labs(y = 'Offer', x= 'Trial', shape = "Receiver's response") + 
   ggtitle('Game results')

belief_plot <- beliefs %>% 
    filter(receiver_dom_level == receiver_dom_level_for_plot,
         sender_dom_level == sender_dom_level_for_plot,
         seed == sid) %>% 
    mutate(`P(0.0)` = `X0.0`,
         `P(0.1)` = `X0.1`,
         `P(0.5)` = `X0.5`) %>% 
  ggplot() + 
  geom_line(aes(x = trial_number, y = `P(0.0)`, colour='`P(0.0)`',
                linetype = factor(sender_dom_level)),
            size=1.0) + 
  geom_line(aes(x = trial_number, y = `P(0.1)`, colour='`P(0.1)`',
                linetype = factor(sender_dom_level)),
            size=1.0) + 
  geom_line(aes(x = trial_number, y = `P(0.5)`, colour='`P(0.5)`',
                linetype = factor(sender_dom_level)),
            size=1.0) + 
  scale_linetype_manual(values=c("solid", "dotted", "solid"))+
  scale_color_viridis_d(name = expression(paste('P(',eta, ')')))+
  facet_grid(receiver_threshold~sender_threshold) + 
  scale_x_continuous(name="Trial", breaks=seq(0, 20, 1)) +
  labs(y = 'Posterior probability', x= 'Trial') + 
  ggtitle('Belief update')

q_value_plot <- q_values %>% 
    filter(receiver_dom_level == receiver_dom_level_for_plot, 
           sender_dom_level == sender_dom_level_for_plot, seed == sid,
           # agent == "DoM(2)_receiver") %>% 
           agent == "DoM(0)_receiver") %>% 
  mutate(response = factor(action, labels = c('reject','accept'))) %>% 
    ggplot(aes(trial_number, q_value, colour = factor(sender_threshold))) + 
  geom_point(aes(shape = response), size=2.0) + 
  scale_shape_manual(values=c(4, 15)) + 
  scale_color_viridis_d(name = expression(paste('P(',gamma, ')')))+
  labs(y = 'Offer', x= 'Trial', shape = "Receiver's response") + 
  ggtitle('DoM(0) receiver Q-values')
  
game_all = game_plot + belief_plot / q_value_plot
# ggsave(sprintf("../figures/simulation_illustration_sender_dom_level_%s_receiver_dom_level_%s.png", sender_dom_level_for_plot, receiver_dom_level_for_plot), width = 40, height = 20, units = "cm")
```


```{r beliefs of the same simulation}
 beliefs %>% 
  filter(receiver_dom_level == "0", sender_dom_level == "-1", seed == 110) %>% 
  mutate(receiver_alpha = factor(receiver_alpha), 
         sender_threshold = factor(sender_threshold)) %>% 
  group_by(trial_number, receiver_threshold, receiver_alpha, sender_threshold) %>% 
  mutate(`P(0.0)` = mean(`X0.0`),
         `P(0.2)` = mean(`X0.2`),
         `P(0.5)` = mean(`X0.5`),
         `P(0.8)` = mean(`X0.8`)) %>% 
  ggplot() + 
  geom_line(aes(x = trial_number, y = `P(0.0)`, colour='`P(0.0)`'),
            size=1.0, alpha = 0.5) + 
  geom_line(aes(x = trial_number, y = `P(0.2)`, colour='`P(0.2)`'),
            size=1.0, alpha = 0.5) + 
  geom_line(aes(x = trial_number, y = `P(0.5)`, colour='`P(0.5)`'),
            size=1.0, alpha = 0.5) + 
  geom_line(aes(x = trial_number, y = `P(0.8)`, colour='`P(0.8)`'),
            size=1.0, alpha = 0.5) + 
  scale_linetype_manual(values=c("twodash", "dotted", "solid"))+
  scale_color_viridis_d(name = expression(paste('P(',gamma, '):')),
                        labels=c("0.0", "0.2", "0.5","0.8"))+
  facet_grid(receiver_alpha~sender_threshold)+
  labs(y = 'Posterior probability', x= 'Trial')
# ggsave("../figures/belief_illustration.png", width = 40, height = 20, units = "cm")
```

