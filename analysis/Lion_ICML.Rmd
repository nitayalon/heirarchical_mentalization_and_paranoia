---
title: "icml_tom_workshop_2023"
author: "Nitay Alon"
date: "2023-05-01"
output: html_document
---

# Loading libraries and data:

```{r setup, include=FALSE}
library(tidyverse)
library(here)
library(colorspace)
library(caret)
library(patchwork)
library(plotly)
library(ks)
library(ggpubr)
library(rstatix)
library(corrr)
library(emmeans)
library(effsize)
library(ARTool)
library(car)        
library(forcats)        
library(RColorBrewer)
```

```{r Plotting settings for aliasing on windows, include=FALSE}
# Plotting settings for aliasing on windows
# Enable anti-aliasing on Windows
if(Sys.info()['sysname'] == "Windows"){
  
  trace(grDevices::png, quote({
    if (missing(type) && missing(antialias)) {
      type <- "cairo-png"
      antialias <- "subpixel"
    }
  }), print = FALSE)
  
  
  # Enable anti-aliasing on Windows
  trace(grDevices:::png, quote({
    if (missing(type) && missing(antialias)) {
      type <- "cairo-png"
      antialias <- "subpixel"
    }
  }), print = FALSE)
  
  
}

# Define general plot style and style
base_size = 15
theme_set(theme_classic(base_size = base_size))

parse_experiment_file <- function(file_name)
{
  parameters_list <- strsplit(file_name, "_")[[1]]
  alpha = parameters_list[4]
  receiver_threshold = parameters_list[7]
  sender_threshold = parameters_list[10]
  return(c(alpha, receiver_threshold, sender_threshold))
}
```

```{r set experiment path, include=FALSE}
current_user <- "nitay"

if(current_user == "lion"){
  result_root <- "/Users/lschulz/Nextcloud/Shared/ICML_2023/softmax/"
} else{
  result_root <- "~/Max_Planck/Hierarchical-modelling/data/first_task/single_rational_agent/"
}

dom_levels = list(
               c("0","-1"),
               c("0","1"))
agents_beliefs <- c("receiver_beliefs", "sender_beliefs")
directory_pattern <- "DoM%s_receiver_DoM%s_sender_softmax_temp_0.1"
path_to_game_results <- paste0(result_root, directory_pattern)
```


```{r Load and merge game data, include=FALSE}
game_results <- c()
for(dom_level in dom_levels)
{
  receiver_dom_level = dom_level[1]
  sender_dom_level = dom_level[2]
  path_to_experiments_results <- sprintf(path_to_game_results, receiver_dom_level, sender_dom_level)
  path_to_dir <- paste(path_to_experiments_results, "simulation_results" ,sep="/")
  temp = list.files(path=path_to_dir, pattern="*.csv")
  if (length(temp) == 0)
    {
      next
    }
  myfiles = lapply(paste(path_to_dir, temp, sep="/"), read.csv)
  interim_results <- bind_rows(myfiles)
  game_results <- rbind(game_results, cbind(interim_results, receiver_dom_level, sender_dom_level))
}
```

```{r load DoM(2) vs Random game results}

results_path = paste0(result_root, "DoM2_receiver_DoM-1_sender_softmax_temp_0.1_random_sender")

path_to_dir <- paste(results_path, "simulation_results/" ,sep="/")
print(path_to_dir)
temp = list.files(path=path_to_dir, pattern="*.csv")
print(temp)
myfiles = lapply(paste(path_to_dir, temp, sep="/"), read.csv)
interim_results <- bind_rows(myfiles)
receiver_dom_level = "2"
sender_dom_level = "-1"
game_results <- rbind(game_results, cbind(interim_results, receiver_dom_level, sender_dom_level))
```


```{r load DoM(2) vs rational subintentional game results}

results_path = paste0(result_root, "DoM2_receiver_DoM-1_sender_softmax_temp_0.1_rational_sender/")


receiver_dom_level = "2"
sender_dom_level = "-1"
path_to_dir <- paste(results_path, "simulation_results/" ,sep="/")
temp = list.files(path=path_to_dir, pattern="*.csv")
myfiles = lapply(paste(path_to_dir, temp, sep="/"), read.csv)
interim_results <- bind_rows(myfiles)
game_results <- rbind(game_results, cbind(interim_results, receiver_dom_level, sender_dom_level))

```


```{r Load and merge beliefs, include=FALSE}
beliefs <- c()
for(dom_level in dom_levels)
{
  receiver_dom_level = dom_level[1]
  sender_dom_level = dom_level[2]
  for(agent_name in agents_beliefs)
  {
    path_to_experiments_results <- sprintf(path_to_game_results, receiver_dom_level, sender_dom_level)
    path_to_dir <- paste(path_to_experiments_results, "beliefs" ,sep="/")
    updated_path = paste(path_to_dir, agent_name, sep="/")
    temp = list.files(path=updated_path, pattern="*.csv")
    if (length(temp) == 0)
    {
      next
    }
    myfiles = lapply(paste(updated_path, temp, sep="/"), read.csv)
    interim_results <- bind_rows(myfiles)
    beliefs <- rbind(beliefs, cbind(interim_results, receiver_dom_level, sender_dom_level))
  }
}
```

```{r load DoM(2) vs Random beliefs}
results_path = paste0(result_root,"DoM2_receiver_DoM-1_sender_softmax_temp_0.1_random_sender/beliefs/receiver_beliefs/")


receiver_dom_level = "2"
sender_dom_level = "-1"
temp = list.files(path=results_path, pattern="*.csv")
myfiles = lapply(paste(results_path, temp, sep="/"), read.csv)
interim_results <- bind_rows(myfiles)
beliefs <- rbind(beliefs, cbind(interim_results, receiver_dom_level, sender_dom_level))
```

```{r load DoM(2) rational subintentional beliefs}

results_path = paste0(result_root, "DoM2_receiver_DoM-1_sender_softmax_temp_0.1_rational_sender/beliefs/receiver_beliefs/")


receiver_dom_level = "2"
sender_dom_level = "-1"
temp = list.files(path=results_path, pattern="*.csv")
myfiles = lapply(paste(results_path, temp, sep="/"), read.csv)
interim_results <- bind_rows(myfiles)
beliefs <- rbind(beliefs, cbind(interim_results, receiver_dom_level, sender_dom_level))
```

```{r load and merge q_values, include=FALSE}
q_values <- c()
for(dom_level in dom_levels)
{
  receiver_dom_level = dom_level[1]
  sender_dom_level = dom_level[2]
  path_to_experiments_results <- sprintf(path_to_game_results, receiver_dom_level, sender_dom_level)
  path_to_dir <- paste(path_to_experiments_results, "q_values" ,sep="/")
  temp = list.files(path=path_to_dir, pattern="*.csv")
  if (length(temp) == 0)
    {
      next
    }
  myfiles = lapply(paste(path_to_dir, temp, sep="/"), read.csv)
  interim_results <- bind_rows(myfiles)
  issue_list <- sapply(myfiles, function(x){class(x$q_value)})
  temp[issue_list == "character"][1]
  myfiles[issue_list == "character"][1]
  q_values <- rbind(q_values, cbind(interim_results, receiver_dom_level, sender_dom_level))
}
```

```{r load DoM(2) vs Random beliefs q values}

results_path = paste0(result_root, "DoM2_receiver_DoM-1_sender_softmax_temp_0.1_random_sender/q_values/")


receiver_dom_level = "2"
sender_dom_level = "1"
temp = list.files(path=results_path, pattern="*.csv")
myfiles = lapply(paste(results_path, temp, sep="/"), read.csv)
interim_results <- bind_rows(myfiles)
q_values <- rbind(q_values, cbind(interim_results, receiver_dom_level, sender_dom_level))
```

# Lion's Plots

```{r}
custom_colors <- list(
  sender_tom = brewer.pal(5, "Reds")[c(2,5)],
  receiver_tom = brewer.pal(5, "Blues")[c(3,5)]
)

pl_initial_sender_offer_by_tom <- 
  game_results %>% 
  filter(receiver_dom_level  == 0, trial_number == 1) %>% 
  mutate(sender_threshold = ifelse(sender_threshold > 0, sender_threshold, "random")) %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold)) %>% 
  group_by(sender_threshold, sender_dom_level) %>%
  mutate(sender_threshold = factor(sender_threshold, levels = c("random", "0.1", "0.5"))) %>% 
  ggplot(aes(sender_threshold, offer, fill = sender_dom_level)) + 
    geom_bar(stat = "summary", position = "dodge") +
    ylab("Average offer") + 
    xlab("Threshold") + 
    ggtitle('Average first\noffer by sender') +
    scale_y_continuous(expand = c(0,0), limits = c(0,0.9)) +
    theme(aspect.ratio = 1, legend.position = c(0.90, 0.8)) +
    scale_fill_manual(values = custom_colors$sender_tom ,
                      name = 'Sender\nDoM') 

pl_initial_sender_offer_by_tom
```

```{r}
threshold_for_recognizing_random <- 0.95

pl_time_to_converge_to_random <-  beliefs %>% 
  filter(agent_name %in% c("DoM(0)_receiver", "DoM(2)_receiver"),
         sender_threshold == 0) %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold),
         receiver_dom_level = factor(receiver_dom_level),
         receiver_threshold = factor(receiver_threshold)) %>% 
  group_by(agent_name, trial_number, receiver_dom_level)  %>% 
  summarize(`P(Random)` = mean(`X0.0`))  %>% 
  mutate(certainty = ifelse(`P(Random)` > threshold_for_recognizing_random, 1, 0)) %>%
  filter(certainty == 1) %>%
  group_by(agent_name) %>%
  summarise(mean_time_for_random = min(trial_number))  %>% 
  mutate(agent_name = factor(agent_name, levels = c("DoM(2)_receiver", "DoM(0)_receiver"))) %>% 
  ggplot(aes(agent_name, mean_time_for_random, fill = agent_name)) +
    geom_col() +
    coord_flip() +
    scale_y_continuous(
      limits = c(0,7.5),
      expand = c(0,0), 
      breaks = 1:10,
      name = "Trial Number") +
    scale_x_discrete(name = "Receiver DoM", labels = c(2,0)) +
    ggtitle("Trials until receiver\nidentifies random") +
    theme(aspect.ratio = 1, legend.position = c(0.80, 0.8)) +
    scale_fill_manual(values = rev(custom_colors$receiver_tom),
                      name = "Receiver\nDoM", labels = c(2,0)) 
pl_time_to_converge_to_random
```


```{r}
pl_total_reward_across_game_paranoia <- game_results %>% 
  filter(sender_dom_level == "-1",
         sender_threshold > 0) %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold),
         receiver_dom_level = factor(receiver_dom_level),
         receiver_threshold = factor(receiver_threshold)) %>% 
  mutate(dyad = fct_cross(sender_dom_level, receiver_dom_level)) %>% 
  group_by(trial_number, sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold) %>% 
  summarise(average_receiver_reward = mean(receiver_reward),
            average_sender_reward = mean(sender_reward)) %>% 
  arrange(sender_dom_level, receiver_dom_level, sender_threshold,
          receiver_threshold) %>% 
  group_by(receiver_threshold, sender_threshold, sender_dom_level, receiver_dom_level) %>% 
  mutate(cumulative_receiver_reward = cumsum(average_receiver_reward),
            cumulative_sender_reward = cumsum(average_sender_reward))  %>%
  group_by(receiver_dom_level) %>% 
  summarize(total_game_reward = sum(cumulative_receiver_reward)) %>% 
  ggplot(aes(receiver_dom_level, total_game_reward, fill = receiver_dom_level)) +
    geom_col() +
    scale_y_continuous(
      expand = c(0,0),
      name = "Sum of Game Reward",
      limits = c(0,14),
      breaks = seq(0,12,2)
    ) +
    ggtitle("Reward by paranoid and\nnon-paranoid ToM agent") +
    scale_x_discrete(
      name = "Receiver DoM level"
    ) +
    theme(aspect.ratio = 1) +
    scale_fill_manual(values = custom_colors$receiver_tom) +
    guides(fill = "none")

pl_total_reward_across_game_paranoia
```


```{r, fig.width=11}
pl_initial_sender_offer_by_tom + pl_time_to_converge_to_random + pl_total_reward_across_game_paranoia + plot_annotation(tag_levels = 'A')
```



```{r plot games for illustration, fig.width=10, fig.height=4}
sid = 210
sender_dom_level_for_plot = 1
receiver_dom_level_for_plot = 0

custom_colors$sender_type <- rev(brewer.pal(n =7, name = "RdPu"))[c(1,4,5)]
custom_colors$accept_reject <- c("white", "white")

custom_shape <- list(
  accept = 22,
  reject = 21
  
)

dynamics_plot_aspect_ratio <- .8

accept_rejct_point_size <- 2.5


pl_domminus1_offers <- game_results %>% 
  filter(receiver_dom_level == 0, 
         sender_dom_level == -1,
         seed == sid) %>% 
  mutate(sender_threshold = factor(sender_threshold),
         response = factor(response, labels = c('reject','accept'))) %>%
  mutate(sender_threshold = factor(sender_threshold)) %>% 
  ggplot(aes(x = trial_number, y = offer)) + 
    geom_line(aes(colour = sender_threshold), size = 1.5) + 
    geom_point(aes(fill = response ,shape = factor(response)), size = accept_rejct_point_size) + 
    scale_fill_manual(values = custom_colors$accept_reject,
                       name = "Receiver response") +
    scale_color_manual(
      values = custom_colors$sender_type,
      name = expression(paste('Sender threshold')),
      labels = c("random", "\u03B7 = 0.1" ,"\u03B7 = 0.5")
      )+
    # scale_shape_manual(values=c(4, 15)) +
    scale_shape_manual(values=c(custom_shape$reject, custom_shape$accept),
                       name = "Receiver response") +
    scale_x_continuous(name="Trial", breaks=seq(0, 10, 1)) +
    scale_y_continuous(limits = c(0,1),breaks = c(0,.5,1)) +
    labs(y = 'Offer', x= 'Trial', shape = "Receiver's response") + 
    ggtitle('Sender Offers: DoM(-1)') +
    theme(aspect.ratio = dynamics_plot_aspect_ratio) +
    guides(color = "none", shape = "none", fill = "none")

pl_dom1_offers <- game_results %>% 
  filter(receiver_dom_level == 0, 
         sender_dom_level == 1,
         seed == sid) %>% 
  mutate(sender_threshold = factor(sender_threshold),
         response = factor(response, labels = c('reject','accept'))) %>%
  mutate(sender_threshold = factor(sender_threshold)) %>% 
  ggplot(aes(x = trial_number, y = offer)) + 
    geom_line(
      aes(
        colour = sender_threshold, 
        linetype = sender_threshold,
        alpha = sender_threshold),
      size = 1.5) + 
    geom_point(aes(fill = response ,shape = factor(response)), size = accept_rejct_point_size) + 
    scale_fill_manual(values = custom_colors$accept_reject,
                       name = "Receiver response") +
    scale_color_manual(
      values = custom_colors$sender_type,
      name = expression(paste('Sender threshold')),
      labels = c("random", "\u03B7 = 0.1" ,"\u03B7 = 0.5")
      ) +
    # scale_shape_manual(values=c(4, 15)) +
    scale_shape_manual(values=c(custom_shape$reject, custom_shape$accept),
                       name = "Receiver response") +
    scale_linetype_manual(values = c("longdash", "solid", "solid")) +
    scale_alpha_manual(values = c(0.3, 1, 1)) +
    scale_x_continuous(name="Trial", breaks=seq(0, 10, 1)) +
    scale_y_continuous(limits = c(0,1),breaks = c(0,.5,1)) +
    labs(y = '', x= 'Trial') + 
    guides(linetype = "none", alpha = "none") +
    ggtitle('Sender Offers: DoM(1)') +
    theme(aspect.ratio = dynamics_plot_aspect_ratio) 

pl_domminus1_offers + pl_dom1_offers + 
 plot_layout(guides = "collect")
```




```{r, fig.width=10, fig.height=4}
pl_beliefs_dom0_domminus1 <- 
  beliefs %>% 
  filter(receiver_dom_level == 0, 
         sender_dom_level == -1,
         seed == sid) %>%  
  mutate(
    `P(0.0)` = `X0.0`,
    `P(0.1)` = `X0.1`
    ) %>% 
  ggplot() + 
    geom_line(aes(x = trial_number, y = `P(0.0)`, colour='`P(0.0)`'), size=1.0) + 
    geom_line(aes(x = trial_number, y = `P(0.1)`, colour='`P(0.1)`'), size=1.0) + 
    scale_linetype_manual(values=c("solid", "dotted", "solid"))+
    scale_color_manual(
      values = custom_colors$sender_type,
      name = expression(paste('Sender threshold')),
      labels = c("random", "\u03B7 = 0.5" ,"\u03B7 = 0.1")) +
    facet_grid(.~sender_threshold) + 
    scale_x_continuous(name = 'Trial', breaks = c(0,5,10) ) +
    scale_y_continuous(name = "Posterior P.", breaks = c(0,1)) +
    ggtitle('Receiver beliefs:\nDoM(0) vs. DoM(-1)') +
    theme(aspect.ratio = 1) +
    guides(color = "none")

pl_beliefs_dom0_dom1 <-
beliefs %>% 
  filter(receiver_dom_level == 0, 
         sender_dom_level == 1,
         seed == sid) %>%  
  mutate(
    `P(0.0)` = `X0.0`,
    `P(0.1)` = `X0.1`
    )  %>% 
  ggplot() + 
    geom_line(aes(x = trial_number, y = `P(0.0)`, colour='`P(0.0)`'), size=1.0) + 
    geom_line(aes(x = trial_number, y = `P(0.1)`, colour='`P(0.1)`'), size=1.0) + 
    scale_linetype_manual(values=c("solid", "dotted", "solid"))+
    scale_color_manual(
      values = custom_colors$sender_type,
      name = expression(paste('Sender threshold')),
      labels = c("random", "\u03B7 = 0.5" ,"\u03B7 = 0.1")) +
    facet_grid(.~sender_threshold)  + 
    scale_x_continuous(name = 'Trial', breaks = c(0,5,10) ) +
    scale_y_continuous(name = "", breaks = c(0,1)) +
    ggtitle('Receiver beliefs:\nDoM(0) vs. DoM(1)') +
    theme(aspect.ratio = 1) +
    guides(color = "none")
```

```{r, fig.width=10, fig.height=4}
pl_beliefs_dom0_domminus1 + pl_beliefs_dom0_dom1 + plot_layout(guides = "collect")
```





Plotting the correct game pairs

```{r, fig.width=11, fig.height=7}
(pl_domminus1_offers / pl_beliefs_dom0_domminus1 + plot_layout(heights = c(5,2))) |
  (pl_dom1_offers / pl_beliefs_dom0_dom1+ plot_layout(heights = c(5,2))) +
  plot_layout(guides = "collect") + plot_annotation(tag_levels = "A")
```



### Paranoia

```{r}
pl_dom1_offers_dom2 <- game_results %>% 
  filter(receiver_dom_level == 2 & sender_dom_level == 1 | receiver_dom_level == 2 & sender_dom_level == -1 & sender_threshold == 0,
         seed == sid) %>% 
  mutate(sender_threshold = factor(sender_threshold),
         response = factor(response, labels = c('reject','accept'))) %>%
  mutate(sender_threshold = factor(sender_threshold)) %>% 
  ggplot(aes(x = trial_number, y = offer)) + 
    geom_line(
      aes(
        colour = sender_threshold, 
        linetype = sender_threshold,
        alpha = sender_threshold),
      size = 1.5) + 
    geom_point(aes(fill = response ,shape = factor(response)), size = accept_rejct_point_size) + 
    scale_fill_manual(values = custom_colors$accept_reject,
                       name = "Receiver response") +
    scale_color_manual(
      values = custom_colors$sender_type,
      name = expression(paste('Sender threshold')),
      labels = c("random", "\u03B7 = 0.1" ,"\u03B7 = 0.5")
      ) +
    # scale_shape_manual(values=c(4, 15)) +
    scale_shape_manual(values=c(custom_shape$reject, custom_shape$accept),
                       name = "Receiver response") +
    scale_linetype_manual(values = c("longdash", "solid", "solid")) +
    scale_alpha_manual(values = c(0.3, 1, 1)) +
    scale_x_continuous(name="Trial", breaks=seq(0, 10, 1)) +
    scale_y_continuous(limits = c(0,1),breaks = c(0,.5,1)) +
    labs(y = '', x= 'Trial') + 
    guides(linetype = "none", alpha = "none") +
    ggtitle('Sender Offers: DoM(1)') +
    theme(aspect.ratio = dynamics_plot_aspect_ratio) +
    guides(color = "none", shape = "none", fill = "none")

pl_dom1_offers_dom2


pl_domminus1_offers_dom2 <- game_results %>% 
  filter(receiver_dom_level == 2 & sender_dom_level == -1 | receiver_dom_level == 2 & sender_dom_level == -1 & sender_threshold == 0,
         seed == sid) %>% 
  mutate(sender_threshold = factor(sender_threshold),
         response = factor(response, labels = c('reject','accept'))) %>%
  mutate(sender_threshold = factor(sender_threshold)) %>% 
  ggplot(aes(x = trial_number, y = offer)) + 
    geom_line(
      aes(
        colour = sender_threshold, 
        linetype = sender_threshold,
        alpha = sender_threshold),
      size = 1.5) + 
    geom_point(aes(fill = response ,shape = factor(response)), size = accept_rejct_point_size) + 
    scale_fill_manual(values = custom_colors$accept_reject,
                       name = "Receiver response") +
    scale_color_manual(
      values = custom_colors$sender_type,
      name = expression(paste('Sender threshold')),
      labels = c("random", "\u03B7 = 0.1" ,"\u03B7 = 0.5")
      ) +
    # scale_shape_manual(values=c(4, 15)) +
    scale_shape_manual(values=c(custom_shape$reject, custom_shape$accept),
                       name = "Receiver response") +
    scale_linetype_manual(values = c("longdash", "solid", "solid")) +
    scale_alpha_manual(values = c(0.3, 1, 1)) +
    scale_x_continuous(name="Trial", breaks=seq(0, 10, 1)) +
    scale_y_continuous(limits = c(0,1),breaks = c(0,.5,1)) +
    labs(y = '', x= 'Trial') + 
    guides(linetype = "none", alpha = "none") +
    ggtitle('Sender Offers: DoM(1)') +
    theme(aspect.ratio = dynamics_plot_aspect_ratio) 

pl_domminus1_offers_dom2
```



```{r}
pl_beliefs_dom1_dom2 <-
beliefs %>% 
  filter(receiver_dom_level == 2 & sender_dom_level == 1 | receiver_dom_level == 2 & sender_dom_level == -1 & sender_threshold == 0,
         seed == sid) %>%  
  mutate(
    `P(0.0)` = `X0.0`,
    `P(0.1)` = `X0.1`,
    `P(0.5)` = `X0.5`
    )  %>% 
  ggplot() + 
    geom_line(aes(x = trial_number, y = `P(0.0)`, colour='`P(0.0)`'), size=1.0) + 
    geom_line(aes(x = trial_number, y = `P(0.1)`, colour='`P(0.1)`'), size=1.0) + 
    geom_line(aes(x = trial_number, y = `P(0.5)`, colour='`P(0.5)`'), size=1.0) + 
    scale_linetype_manual(values=c("solid", "dotted", "solid"))+
    scale_color_manual(
      values = custom_colors$sender_type,
      name = expression(paste('Sender threshold')),
      labels = c("random", "\u03B7 = 0.5" ,"\u03B7 = 0.1")) +
    facet_grid(.~sender_threshold)  + 
    scale_x_continuous(name = 'Trial', breaks = c(0,5,10) ) +
    scale_y_continuous(name = "", breaks = c(0,1)) +
    ggtitle('Receiver beliefs:\nDoM(2) vs. DoM(1)') +
    theme(aspect.ratio = 1) +
    guides(color = "none")


pl_beliefs_dom1_dom2

pl_beliefs_domminus1_dom2 <-
beliefs %>% 
  filter(receiver_dom_level == 2 & sender_dom_level == -1 | receiver_dom_level == 2 & sender_dom_level == -1 & sender_threshold == 0,
         seed == sid) %>%  
  mutate(
    `P(0.0)` = `X0.0`,
    `P(0.1)` = `X0.1`,
    `P(0.5)` = `X0.5`
    )  %>% 
  ggplot() + 
    geom_line(aes(x = trial_number, y = `P(0.0)`, colour='`P(0.0)`'), size=1.0) + 
    geom_line(aes(x = trial_number, y = `P(0.1)`, colour='`P(0.1)`'), size=1.0) + 
    geom_line(aes(x = trial_number, y = `P(0.5)`, colour='`P(0.5)`'), size=1.0) + 
    scale_linetype_manual(values=c("solid", "dotted", "solid"))+
    scale_color_manual(
      values = custom_colors$sender_type,
      name = expression(paste('Sender threshold')),
      labels = c("random", "\u03B7 = 0.5" ,"\u03B7 = 0.1")) +
    facet_grid(.~sender_threshold)  + 
    scale_x_continuous(name = 'Trial', breaks = c(0,5,10) ) +
    scale_y_continuous(name = "", breaks = c(0,1)) +
    ggtitle('Receiver beliefs:\nDoM(2) vs. DoM(1)') +
    theme(aspect.ratio = 1) +
    guides(color = "none")


pl_beliefs_domminus1_dom2
```

```{r, fig.width=11, fig.height=7}
(pl_dom1_offers_dom2 / pl_beliefs_dom1_dom2 + plot_layout(heights = c(5,2))) |
  (pl_domminus1_offers_dom2 / pl_beliefs_domminus1_dom2+ plot_layout(heights = c(5,2))) +
  plot_layout(guides = "collect") + plot_annotation(tag_levels = "A")
```

### Better paranoia plots

#### Belief dynamics

```{r}
aspect_ratio_paranoia <- .66
linesize_paranoia <- 1
```


```{r}
pl_receiver_beliefs_random <- beliefs %>% 
  filter(
    sender_threshold == 0
  ) %>%  
  mutate(
    `P(0.0)` = `X0.0`,
    `P(0.1)` = `X0.1`,
    `P(0.5)` = `X0.5`
    )  %>% 
  group_by(trial_number, sender_threshold, receiver_dom_level) %>% 
  summarise(
    mean_p0 = mean(`P(0.0)`),
    mean_p01 = mean(`P(0.1)`),
    mean_p05 = mean(`P(0.5)`)
  ) %>% 
ggplot(aes(x = trial_number, y = mean_p0, colour = receiver_dom_level, fill = receiver_dom_level)) + 
  geom_line(size=linesize_paranoia) + 
  scale_linetype_manual(values=c("solid", "dotted", "solid"))+
  scale_color_manual(
    values = custom_colors$receiver_tom,
    name = expression(paste('Receiver DoM'))) +
  scale_x_continuous(name = 'Trial', breaks = 0:10) +
  scale_y_continuous(name = "P(\u03F4 = random)" , limits = c(0,1), breaks = c(0,.5,1)) +
  ggtitle('DoM(2) and Dom(0) beliefs',
          subtitle = "Playing against DoM(-1) with \u03F4 = random" ) +
  theme(aspect.ratio = aspect_ratio_paranoia) 

pl_receiver_beliefs_random


pl_receiver_beliefs_eta01 <- beliefs %>% 
  filter(
    sender_threshold == 0.1,
    sender_dom_level == 1,
    receiver_dom_level %in% c(0,2)
  ) %>%  
  mutate(
    `P(0.0)` = `X0.0`,
    `P(0.1)` = `X0.1`,
    `P(0.5)` = `X0.5`
    )  %>% 
  group_by(
    trial_number, 
    sender_threshold, 
    receiver_dom_level) %>% 
  summarise(
    mean_p0 = mean(`P(0.0)`),
    mean_p01 = mean(`P(0.1)`),
    mean_p05 = mean(`P(0.5)`)
  ) %>% 
ggplot(aes(x = trial_number, y = mean_p01, colour = receiver_dom_level, fill = receiver_dom_level)) + 
  geom_line(size=linesize_paranoia) +
  scale_linetype_manual(values=c("solid", "dotted", "solid"))+
  scale_color_manual(
    values = custom_colors$receiver_tom,
    name = expression(paste('Receiver DoM'))) +
  scale_x_continuous(name = 'Trial', breaks = 0:10) +
  scale_y_continuous(name = "P(\u03B7 = .1)" , limits = c(0,1), breaks = c(0,.5,1)) +
  ggtitle('',
          subtitle = "Playing against DoM(1) with \u03B7 = .1" ) +
  # ggtitle('Receiver beliefs with different thresholds\nDoM(2)and Dom(0) vs. DoM(1)') +
  theme(aspect.ratio = aspect_ratio_paranoia) 

pl_receiver_beliefs_eta01

pl_receiver_beliefs_eta05 <- beliefs %>% 
  filter(
    sender_threshold == 0.5,
    sender_dom_level == 1,
    receiver_dom_level %in% c(0,2)
  ) %>%  
  mutate(
    `P(0.0)` = `X0.0`,
    `P(0.1)` = `X0.1`,
    `P(0.5)` = `X0.5`
    )  %>% 
  group_by(
    trial_number, 
    sender_threshold, 
    receiver_dom_level) %>% 
  summarise(
    mean_p0 = mean(`P(0.0)`),
    mean_p01 = mean(`P(0.1)`),
    mean_p05 = mean(`P(0.5)`)
  ) %>% 
ggplot(aes(x = trial_number, y = mean_p05, colour = receiver_dom_level, fill = receiver_dom_level)) + 
  geom_line(size=linesize_paranoia) +
  scale_linetype_manual(values=c("solid", "dotted", "solid"))+
  scale_color_manual(
    values = custom_colors$receiver_tom,
    name = expression(paste('Receiver DoM'))) +
  scale_x_continuous(name = 'Trial', breaks = 0:10) +
  scale_y_continuous(name = "P(\u03B7 = .5)" , limits = c(0,1), breaks = c(0,.5,1)) +
  ggtitle('',
          subtitle = "Playing against DoM(1) with \u03B7 = .5" ) +
  # ggtitle('Receiver beliefs with different thresholds\nDoM(2)and Dom(0) vs. DoM(1)') +
  theme(aspect.ratio = aspect_ratio_paranoia) 

pl_receiver_beliefs_eta05
```

#### Acceptance dynamics

```{r}
pl_acceptance_random <- game_results %>% 
  filter(
    sender_threshold == 0
  ) %>% 
  group_by(
    trial_number, 
    sender_threshold, 
    receiver_dom_level
    ) %>% 
  summarise(
    response = mean(response)
  ) %>% 
  ggplot(aes(x = trial_number, y = as.numeric(response), colour = receiver_dom_level)) + 
    geom_line(size=linesize_paranoia) +
    scale_x_continuous(name = 'Trial', breaks = 0:10) +
    scale_y_continuous(name = "Average Acceptance" , limits = c(0,1), breaks = c(0,.5,1)) +
    scale_color_manual(
      values = custom_colors$receiver_tom,
      name = expression(paste('Receiver DoM'))) +
    ggtitle('DoM(2) and DoM(1) acceptance',
          subtitle = "Playing against DoM(-1) with \u03F4 = random" ) +
    theme(aspect.ratio = aspect_ratio_paranoia) 

pl_acceptance_01 <- game_results %>% 
  filter(
    sender_threshold == 0.1,
    receiver_dom_level == 2 & sender_dom_level == 1 | receiver_dom_level == 0 & sender_dom_level == -1 
  ) %>%  
  group_by(
    trial_number, 
    sender_threshold, 
    receiver_dom_level
    ) %>% 
  summarise(
    response = mean(response)
  ) %>% 
  ggplot(aes(x = trial_number, y = as.numeric(response), colour = receiver_dom_level)) + 
  geom_line(size=linesize_paranoia) +
  scale_x_continuous(name = 'Trial', breaks = 0:10) +
  scale_y_continuous(name = "Average Acceptance" , limits = c(0,1), breaks = c(0,.5,1)) +
  scale_color_manual(
    values = custom_colors$receiver_tom,
    name = expression(paste('Receiver DoM')))  +
  ggtitle( "", subtitle = "Playing against DoM(1) and DoM(-1) with \u03B7 = .1") +
  theme(aspect.ratio = aspect_ratio_paranoia) 

pl_acceptance_05 <- game_results %>% 
  filter(
    sender_threshold == 0.5,,
    receiver_dom_level == 2 & sender_dom_level == 1 | receiver_dom_level == 0 & sender_dom_level == -1 
  ) %>%  
  group_by(
    trial_number, 
    sender_threshold, 
    receiver_dom_level
    ) %>% 
  summarise(
    response = mean(response)
  ) %>% 
  ggplot(aes(x = trial_number, y = as.numeric(response), colour = receiver_dom_level)) + 
  geom_line(size=linesize_paranoia) +
  scale_x_continuous(name = 'Trial', breaks = 0:10) +
  scale_y_continuous(name = "Average Acceptance" , limits = c(0,1), breaks = c(0,.5,1)) +
  scale_color_manual(
    values = custom_colors$receiver_tom,
    name = expression(paste('Receiver DoM')))+
  ggtitle( "", subtitle = "Playing against DoM(1) and DoM(-1) with \u03B7 = .5") +
  theme(aspect.ratio = aspect_ratio_paranoia) 
    
```


```{r, fig.height=11}
pl_receiver_beliefs_random + pl_receiver_beliefs_eta01 +  pl_receiver_beliefs_eta05 +
 pl_acceptance_random + pl_acceptance_01 + pl_acceptance_05 +
plot_layout(ncol = 3, guides = "collect") 
```

```{r, fig.height=11}
pl_receiver_beliefs_random + pl_acceptance_random +
pl_receiver_beliefs_eta01 + pl_acceptance_01 +
pl_receiver_beliefs_eta05 + pl_acceptance_05 +
plot_layout(ncol = 2, guides = "collect") 
```


### Losses incurred by the ToM(2)

```{r}
pl_domminus1_offers_dom2 <- game_results %>% 
  filter(receiver_dom_level == 2 & sender_dom_level == -1 | receiver_dom_level == 2 & sender_dom_level == -1 & sender_threshold == 0,
         seed == sid) %>% 
  mutate(sender_threshold = factor(sender_threshold),
         response = factor(response, labels = c('reject','accept'))) %>%
  mutate(sender_threshold = factor(sender_threshold)) %>% 
  ggplot(aes(x = trial_number, y = offer)) + 
    geom_line(
      aes(
        colour = sender_threshold, 
        linetype = sender_threshold,
        alpha = sender_threshold),
      size = 1.5) + 
    geom_point(aes(fill = response ,shape = factor(response)), size = accept_rejct_point_size) + 
    scale_fill_manual(values = custom_colors$accept_reject,
                       name = "Receiver response") +
    scale_color_manual(
      values = custom_colors$sender_type,
      name = expression(paste('Sender threshold')),
      labels = c("random", "\u03B7 = 0.1" ,"\u03B7 = 0.5")
      ) +
    # scale_shape_manual(values=c(4, 15)) +
    scale_shape_manual(values=c(custom_shape$reject, custom_shape$accept),
                       name = "Receiver response") +
    scale_linetype_manual(values = c("longdash", "solid", "solid")) +
    scale_alpha_manual(values = c(0.3, 1, 1)) +
    scale_x_continuous(name="Trial", breaks=seq(0, 10, 1)) +
    scale_y_continuous(limits = c(0,1),breaks = c(0,.5,1)) +
    labs(y = '', x= 'Trial') + 
    guides(linetype = "none", alpha = "none") +
    ggtitle("DoM(2) vs. DoM(-1) dynamics", 
          subtitle = "Misaligned DoM") +
    theme(aspect.ratio = dynamics_plot_aspect_ratio) 

pl_domminus1_offers_dom2
```



```{r}
receiver_reward <- game_results %>% 
  filter(sender_dom_level == "-1") %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold),
         receiver_dom_level = factor(receiver_dom_level),
         receiver_threshold = factor(receiver_threshold)) %>% 
  mutate(dyad = fct_cross(sender_dom_level, receiver_dom_level)) %>% 
  group_by(trial_number, sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold) %>% 
  summarise(average_receiver_reward = mean(receiver_reward),
            average_sender_reward = mean(sender_reward)) %>% 
  arrange(sender_dom_level, receiver_dom_level, sender_threshold,
          receiver_threshold) %>% 
  group_by(receiver_threshold, sender_threshold, sender_dom_level, receiver_dom_level) %>% 
  mutate(cumulative_receiver_reward = cumsum(average_receiver_reward),
            cumulative_sender_reward = cumsum(average_sender_reward)) %>% 
  ggplot(aes(trial_number, cumulative_receiver_reward, colour = receiver_dom_level)) + 
  geom_line(size = 1.0) + 
  ylab("Cumulative receiver reward") + 
  xlab("Trial number") + 
  scale_color_viridis_d(name = expression(paste("Receiver's DoM")))+
  facet_grid(.~sender_threshold) +
  scale_color_manual(
    values = custom_colors$receiver_tom,
    name = expression(paste('Receiver DoM'))) +
  ggtitle("Cummul. reward for DoM(2) and DoM(0)", 
          subtitle = "Playing against DoM(-1)")

receiver_reward
```


```{r, fig.width=12}
pl_domminus1_offers_dom2 + receiver_reward + plot_layout(guides = "collect")
```


# Plots

Sender's first offer by threshold and $DoM$ level:

```{r sender first offer by type}
sender_policy <- 
  game_results %>% 
  filter(receiver_dom_level  == 0) %>% 
  mutate(sender_threshold = ifelse(sender_threshold > 0, sender_threshold, "random")) %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold),
         receiver_dom_level = factor(receiver_dom_level),
         receiver_threshold = factor(receiver_threshold)) %>% 
  group_by(trial_number, sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold) %>% 
  summarise(average_offer = mean(offer),
            average_reponse = mean(response)) %>% 
  arrange(sender_dom_level, receiver_dom_level, sender_threshold, receiver_threshold, trial_number) %>% 
  ggplot(aes(trial_number, average_offer, colour = sender_dom_level)) + 
  geom_line(size = 1.0) + 
  ylab("Average offer") + 
  xlab("Trial number") + 
  scale_color_viridis_d(name = expression(paste('Sender DoM')))+
  facet_grid(. ~ sender_threshold) +
  ggtitle('Sender policy')

sender_policy
```


```{r sender first offer distribution by type}
sender_policy <- 
  game_results %>% 
  filter(receiver_dom_level  == 0, trial_number == 1,
          sender_threshold > 0) %>% 
  mutate(sender_threshold = ifelse(sender_threshold > 0, sender_threshold, "random")) %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold),
         receiver_dom_level = factor(receiver_dom_level),
         receiver_threshold = factor(receiver_threshold)) %>% 
  ggplot(aes(offer, fill = sender_dom_level)) + 
  geom_density(bins = 10, size = 1.0, alpha = 0.5) + 
  ylab("Average offer") + 
  xlab("Trial number") + 
  scale_fill_viridis_d(name = expression(paste('Sender DoM')))+
  facet_grid(. ~ sender_threshold) +
  ggtitle('Distribution of first offer')

sender_policy
```

```{r sender first offer distribution by type}
sender_policy <- 
  game_results %>% 
  filter(receiver_dom_level  == 0, trial_number == 1) %>% 
  mutate(sender_threshold = ifelse(sender_threshold > 0, sender_threshold, "random")) %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold)) %>% 
  group_by(sender_threshold, sender_dom_level) %>% 
  ggplot(aes(sender_threshold, offer, fill = sender_dom_level)) + 
  geom_boxplot(alpha=0.7, outlier.alpha = 0) +
    stat_summary(fun.y=mean, geom="point", shape=20, 
                 position = position_dodge(width=0.75), size=3, color="red") +
  ylab("Average offer") + 
  xlab("Trial number") + 
  scale_fill_viridis_d(name = expression(paste('Sender DoM')))+
  ggtitle('Distribution of first offer')

sender_policy
```
```{r how fast does it take to convince the receiver that you are random}
corresponding_beliefs <- 
  beliefs %>% 
  filter(agent_name %in% c("DoM(0)_receiver", "DoM(2)_receiver")) %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold),
         receiver_dom_level = factor(receiver_dom_level),
         receiver_threshold = factor(receiver_threshold)) %>% 
  group_by(agent_name, trial_number, sender_dom_level, receiver_dom_level,
           receiver_threshold, sender_threshold) %>% 
  mutate(`P(Random)` = mean(`X0.0`),
         `P(0.1)` = mean(`X0.1`),
         `P(0.5)` = mean(`X0.5`)) %>% 
  ggplot() + 
  geom_line(aes(x = trial_number, y = `P(Random)`, colour='`P(Random)`',
                linetype = factor(sender_dom_level)),
            size=1.0) + 
  geom_line(aes(x = trial_number, y = `P(0.1)`, colour='`P(0.1)`',
                linetype = factor(sender_dom_level)),
            size=1.0) + 
  geom_line(aes(x = trial_number, y = `P(0.5)`, colour='`P(0.5)`',
                linetype = factor(sender_dom_level)),
            size=1.0) + 
  scale_linetype_manual(values=c("solid", "dotted", "solid"))+
  scale_color_viridis_d(name = expression(paste('P(',eta, ')')))+
  facet_grid(agent_name ~ sender_threshold) + 
  labs(y = 'Posterior probability', x= 'Trial')+
  scale_linetype_manual("Sender DoM",values=c("-1"=3,"1"=1)) + 
  ggtitle('Reciever posterior belief')
corresponding_beliefs
```
```{r time until the receiver decide that it playes with a random agent}
corresponding_beliefs <- 
  beliefs %>% 
  filter(agent_name %in% c("DoM(0)_receiver", "DoM(2)_receiver"),
         sender_threshold == 0) %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold),
         receiver_dom_level = factor(receiver_dom_level),
         receiver_threshold = factor(receiver_threshold)) %>% 
  group_by(agent_name, trial_number, receiver_dom_level) %>% 
  mutate(`P(Random)` = mean(`X0.0`)) %>% 
  mutate(certainty = ifelse(`P(Random)` > 0.99, 1, 0)) %>% 
  summarize(mean_time_to_call_random = mean(certainty)) %>% 
  ggplot(aes(trial_number, mean_time_to_call_random, colour = receiver_dom_level)) + 
  scale_color_viridis_d(name = "Receivre's DoM")+
  geom_line(size = 2) + 
  labs(y = 'Confidence level', x= 'Trial')
corresponding_beliefs
```
```{r how bad overmentalisation is}
receiver_reward <- game_results %>% 
  filter(sender_dom_level == "-1",
         # sender_threshold > 0,
         seed == 210) %>% 
  mutate(sender_dom_level = factor(sender_dom_level),
         sender_threshold = factor(sender_threshold),
         receiver_dom_level = factor(receiver_dom_level),
         receiver_threshold = factor(receiver_threshold)) %>% 
  mutate(dyad = fct_cross(sender_dom_level, receiver_dom_level)) %>% 
  group_by(trial_number, sender_dom_level, receiver_dom_level,  receiver_threshold, sender_threshold) %>% 
  summarise(average_receiver_reward = mean(receiver_reward),
            average_sender_reward = mean(sender_reward)) %>% 
  arrange(sender_dom_level, receiver_dom_level, sender_threshold,
          receiver_threshold) %>% 
  group_by(receiver_threshold, sender_threshold, sender_dom_level, receiver_dom_level) %>% 
  mutate(cumulative_receiver_reward = cumsum(average_receiver_reward),
            cumulative_sender_reward = cumsum(average_sender_reward)) %>% 
  ggplot(aes(trial_number, cumulative_receiver_reward, colour = receiver_dom_level)) + 
  geom_line(size = 1.0, alpha = 0.5) + 
  ylab("Cumulative receiver reward") + 
  xlab("Trial number") + 
  scale_color_viridis_d(name = expression(paste("Receiver's DoM")))+
  facet_grid(.~sender_threshold) 

receiver_reward
```

<<<<<<< HEAD

=======
```{r plot games for illustration}
sid = 210
sender_dom_level_for_plot = -1
receiver_dom_level_for_plot = 0

game_plot <- game_results %>% 
  filter(receiver_dom_level == receiver_dom_level_for_plot,
         sender_dom_level == sender_dom_level_for_plot,
         seed == sid) %>% 
  mutate(sender_threshold = factor(sender_threshold),
         # response = factor(response, labels = c('reject','accept'))) %>%
         response = factor(response, labels = c('accept'))) %>%
  mutate(sender_threshold = factor(sender_threshold)) %>% 
  ggplot(aes(x = trial_number, y = offer)) + 
  geom_point(aes(shape = factor(response)), size = 1.5) + 
  geom_line(aes(colour = sender_threshold), alpha=0.5, size = 1.5) + 
  scale_color_viridis_d(name = expression(paste('Sender threshold')))+
  # scale_shape_manual(values=c(4, 15)) +
  scale_shape_manual(values=c(15, 4)) +
  scale_x_continuous(name="Trial", breaks=seq(0, 20, 1)) +
  labs(y = 'Offer', x= 'Trial', shape = "Receiver's response") + 
   ggtitle('Game results')

belief_plot <- beliefs %>% 
    filter(receiver_dom_level == receiver_dom_level_for_plot,
         sender_dom_level == sender_dom_level_for_plot,
         seed == sid) %>% 
    mutate(`P(0.0)` = `X0.0`,
         `P(0.1)` = `X0.1`,
         `P(0.5)` = `X0.5`) %>% 
  ggplot() + 
  geom_line(aes(x = trial_number, y = `P(0.0)`, colour='`P(0.0)`',
                linetype = factor(sender_dom_level)),
            size=1.0) + 
  geom_line(aes(x = trial_number, y = `P(0.1)`, colour='`P(0.1)`',
                linetype = factor(sender_dom_level)),
            size=1.0) + 
  geom_line(aes(x = trial_number, y = `P(0.5)`, colour='`P(0.5)`',
                linetype = factor(sender_dom_level)),
            size=1.0) + 
  scale_linetype_manual(values=c("solid", "dotted", "solid"))+
  scale_color_viridis_d(name = expression(paste('P(',eta, ')')))+
  facet_grid(receiver_threshold~sender_threshold) + 
  scale_x_continuous(name="Trial", breaks=seq(0, 20, 1)) +
  labs(y = 'Posterior probability', x= 'Trial') + 
  ggtitle('Belief update')

q_value_plot <- q_values %>% 
    filter(receiver_dom_level == receiver_dom_level_for_plot, 
           sender_dom_level == sender_dom_level_for_plot, seed == sid,
           # agent == "DoM(2)_receiver") %>% 
           agent == "DoM(0)_receiver") %>% 
  mutate(response = factor(action, labels = c('reject','accept'))) %>% 
    ggplot(aes(trial_number, q_value, colour = factor(sender_threshold))) + 
  geom_point(aes(shape = response), size=2.0) + 
  scale_shape_manual(values=c(4, 15)) + 
  scale_color_viridis_d(name = expression(paste('P(',gamma, ')')))+
  labs(y = 'Offer', x= 'Trial', shape = "Receiver's response") + 
  ggtitle('DoM(0) receiver Q-values')
  
game_all = game_plot / belief_plot
# ggsave(sprintf("../figures/simulation_illustration_sender_dom_level_%s_receiver_dom_level_%s.png", sender_dom_level_for_plot, receiver_dom_level_for_plot), width = 40, height = 20, units = "cm")
game_all
```
>>>>>>> 6b5543770c1d74ba76affeff0798a21ad61d11f5
